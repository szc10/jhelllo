window.onload=function(){if(/iP(hone|ad)/.test(window.navigator.userAgent)){document.body.addEventListener("touchstart",function(){},false)}};var jsBox={};jsBox.isArray=function(o){return Object.prototype.toString.apply(o)==="[object Array]"};jsBox.isFunction=function(o){return Object.prototype.toString.apply(o)==="[object Function]"};var $_GET=J_GET=function(){var url=window.document.location.href.toString();var u=url.split("?");if(typeof u[1]=="string"){u=u[1].split("&");var get={};for(var i in u){var j=u[i].split("=");get[j[0]]=j[1]}return get}else{return{}}}();var findChild=function(dom){del_space(dom);var kids=new Array;for(var i=0;i<dom.childNodes.length;i++){kids[i]=dom.childNodes[i]}return kids};function extend(subClass,superClass){var F=function(){};F.prototype=superClass.prototype;subClass.prototype=new F;subClass.prototype.constructor=subClass;subClass.superClass=superClass.prototype;if(superClass.prototype.constructor==Object.prototype.constructor){superClass.prototype.constructor=superClass}}function hasclass(ele,cls){return ele.className.match(new RegExp("(\\s|^)"+cls+"(\\s|$)"))}function AddEvent(ele,ev,fn){try{if(!ele)throw"element is null";else{if(ele.attachEvent!=null){ele.attachEvent("on"+ev,fn)}else{ele.addEventListener(ev,fn,false)}}}catch(err){alert(err)}}function removeEvent(ele,ev,fn){try{if(!ele)throw"element is null";else{ele.removeEventListener(ev,fn)}}catch(err){alert(err)}}function stopBubble(ev){if(ev&&ev.stopPropagation)ev.stopPropagation();else window.event.cancelBubble=true}function del_space(ele){var ele_child=ele.childNodes;for(var i=0;i<ele_child.length;i++){if(ele_child[i].nodeName=="#text"&&!/\s/.test(ele_child.nodeValue)){ele.removeChild(ele_child[i])}}}function positeDom(position_dom,need_move_dom){function getSreen(){var height=0;var width=0;if(window.innerHeight){height=window.innerHeight;width=window.innerWidth}else if(document.body.clientHeight){height=document.body.clientHeight;width=document.body.clientWidth}return{width:width,height:height}}var date_input=position_dom;var left=date_input.getBoundingClientRect().left;var top=date_input.getBoundingClientRect().top;var width=date_input.offsetWidth;var height=date_input.offsetHeight;var innerHeight=getSreen().height;var innerWidth=getSreen().width;need_move_dom.style.display="block";if(innerWidth-left<need_move_dom.offsetWidth){need_move_dom.style.left=left-need_move_dom.offsetWidth/2+"px"}else{need_move_dom.style.left=left+"px"}if(innerHeight-top-height<need_move_dom.offsetHeight){need_move_dom.style.top=top-need_move_dom.offsetHeight-height+"px"}else{need_move_dom.style.top=top+height+"px"}}var CSS=function(){var styleElement;function insertCSSRule(rule){if(styleElement){var number=0;try{var sheet=styleElement.sheet;var cssRules=sheet.cssRules;number=cssRules.length;sheet.insertRule(rule,number)}catch(e){console.log(e.message+rule)}}else{styleElement=document.createElement("style");styleElement.innerHTML=rule;document.head.appendChild(styleElement)}}var fn={insertRule:function(rule){insertCSSRule(rule);return fn},deleteRule:function(ruleName){var sheet=styleElement.sheet;var cssRules=sheet.cssRules;for(var i=0,n=cssRules.length;i<n;i++){var rule=cssRules[i];if(rule.selectorText==ruleName){sheet.deleteRule(i);break}}return fn}};return fn}();CSS.insertRule("._hide{ display:none} !important;");var J=function(ele){if(ele.constructor==String){if(!(this instanceof J)){return new J(ele)}try{if(!document.getElementById(ele))throw ele+" is not find";this.thisp=document.getElementById(ele)}catch(err){console.log(err)}}else if(ele.nodeType==Node.ELEMENT_NODE){if(!(this instanceof J)){return new J(ele)}this.thisp=ele}this.style=this.thisp.style;this.src=this.thisp.src;this.getcss=function(key){var cssArray=window.getComputedStyle?window.getComputedStyle(this.thisp,""):this.thisp.currentStyle;return cssArray[key]};this.setcss=function(style,value){this.style[style]=value;return this};return this};J.prototype={touchstart:function(fun){AddEvent(this.thisp,"touchstart",fun);return this},touchend:function(fun){AddEvent(this.thisp,"touchend",fun);return this},click:function(fun){AddEvent(this.thisp,"click",fun);return this},dblclick:function(fun){AddEvent(this.thisp,"dblclick",fun);return this},blur:function(fun){AddEvent(this.thisp,"blur",fun);return this},change:function(fun){AddEvent(this.thisp,"change",fun);return this},focus:function(fun){AddEvent(this.thisp,"focus",fun);return this},mousemove:function(fun){AddEvent(this.thisp,"mousemove",fun);return this},mouseout:function(fun){AddEvent(this.thisp,"mouseout",fun);return this},positeDom:function(position_dom){positeDom(position_dom,this.thisp)},hide:function(){this.addClass("_hide")}};J.prototype.getType=function(type){return this.thisp[type]};J.prototype.setType=function(type,value){this.thisp[type]=value;return this};J.prototype.append=function(part){this.thisp.innerHTML+=part;return this};J.prototype.setValue=function(value){this.thisp.value=value;return this};J.prototype.getValue=function(){return this.thisp.value};J.prototype.getHtml=function(){return this.thisp.innerHTML};J.prototype.setHtml=function(html){var temp=""||html;this.thisp.innerHTML=temp;return this};J.prototype.addClass=function(cla){if(!hasclass(this.thisp,cla))this.thisp.className+=" "+cla;return this};J.prototype.removeClass=function(cla){if(hasclass(this.thisp,cla)){var reg=new RegExp("(\\s|^)"+cla+"(\\s|$)");this.thisp.className=this.thisp.className.replace(reg," ")}return this};J.prototype.toggleClass=function(cla){if(hasclass(this.thisp,cla)){this.removeClass(cla)}else this.addClass(cla);return this};J.prototype.findChild=function(){del_space(this.thisp);var kids=new Array;for(var i=0;i<this.thisp.childNodes.length;i++){kids[i]=J(this.thisp.childNodes[i])}return kids};J.prototype.domAll=function(selector){return this.thisp.querySelectorAll(selector)};J.prototype.domFirst=function(selector){return this.thisp.querySelector(selector)};var Jajax=function(config){var file=config.file;var url=config.url;var data=config.data;var complete=config.complete;var callback=config.callback;var json_back=config.json_back;var error=config.error;var type=config.type||"post";var form=null;var xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");if(type=="GET"||type=="get"){url+="?";data=function(obj){var str="";for(var name in obj){str+=name+"="+obj[name]+"&"}return str}(data);url+=data;xhr.open("get",url,true);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}else{form=new FormData;for(var filename in file)form.append(filename,file[filename]);for(var name in data)form.append(name,data[name])}xhr.onreadystatechange=_onreadystatechange;if(type=="get"||type=="GET"){xhr.send()}else{xhr.open("post",url,true);xhr.send(form)}function _onreadystatechange(){if(xhr.readyState==4)if(xhr.status==200){if(json_back==true){var result=xhr.responseText;if(result)var re=eval("("+result+")");else var re="";complete(re)}else{complete(xhr.responseText)}if(jsBox.isFunction(callback)){callback()}}else{if(jsBox.isFunction(error)){error()}console.log("error:readyState:"+xhr.readyState+"status:"+xhr.status)}}};var Cookie={set:function(key,value,expiredays){var exdate=new Date;exdate.setDate(exdate.getDate()+expiredays);var the_cookie=key+"="+value+";";the_cookie+=expiredays==null?"":";expires="+exdate.toGMTString();the_cookie=the_cookie+"path=/;";the_cookie=the_cookie+"domain="+document.domain+";";document.cookie=the_cookie},get:function(key){if(document.cookie.length>0){c_start=document.cookie.indexOf(key+"=");if(c_start!=-1){c_start=c_start+key.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1)c_end=document.cookie.length;return unescape(document.cookie.substring(c_start,c_end))}}return false}};var Jtmpl=function(tmpl){if(document.getElementById(tmpl)){var html=document.getElementById(tmpl).innerHTML}else if(tmpl.nodeType==Node.ELEMENT_NODE){var html=tmpl.innerHTML}else{var html=tmpl}var p=[];var dealHtml=html.replace(/{{=(.*?)}}/g,"');p.push($1);p.push('");dealHtml=dealHtml.replace(/{{/g,"');");dealHtml=dealHtml.replace(/}}/g,"p.push('");dealHtml="var p=[];p.push('"+dealHtml+"'); return p.join(''); ";dealHtml=dealHtml.replace(/[\r\t\n]/g,"");dealHtml=dealHtml.replace(/&lt;/g,"<");try{var fn=new Function("data",dealHtml)}catch(e){console.log(e)}this.createHtml=function(data){var html;html=fn(data);return html};this.getFunction=function(){return new Function("data","method",dealHtml)}};Action=function(){var tapInf={target:null,signal:null};var domAction=[];domAction["click"]=[];domAction["change"]=[];domAction["bgclick"]=[];var listener=document;AddEvent(document,"click",function(e){for(var i in domAction.bgclick){domAction.bgclick[i].call();delete domAction.bgclick[i]}});for(var eventType in domAction){var listener=document.getElementsByTagName("viewport")[0]||document;listener.addEventListener(eventType,function(ev){var target=ev.target;var id=target.id;var type=ev.type;var actionArr=getDomActionArr(target);dealAction.call(ev.target,type,id);for(var i=0;i<actionArr.length;i++){dealAction.call(target,type,actionArr[i])}function dealAction(type,action){if(domAction[type][action]){domAction[type][action].call(this)}else{return}}function getDomActionArr(){if(target.dataset.action){return target.dataset.action.split(" ")}else if(target.parentNode.dataset){target=target.parentNode;if(target.dataset.action)return target.dataset.action.split(" ");else return[]}else{return[]}}})}domAction["tap"]=[];document.addEventListener("touchstart",function(ev){tapInf.target=ev.target;tapInf.signal=1},false);document.addEventListener("touchmove",function(){tapInf.signal=null},false);document.addEventListener("touchend",function(){if(tapInf.signal==1){var type="tap";var target=tapInf.target;var id=target.id;var action=target.dataset.action;if(domAction[type][id]){domAction[type][id].call(target)}else if(domAction[type][action]){domAction[type][action].call(target)}}tapInf.signal=null},false);return{click:function(action,fn){domAction["click"][action]=fn},change:function(action,fn){domAction.change[action]=fn},tap:function(action,fn){domAction.tap[action]=fn},getDomAction:function(){return domAction},setBgClickAction:function(fn){domAction.bgclick.push(fn)}}}();var URLrouter=function(){var url=window.document.location.href.toString();var u=url.split("#");var hash=[];if(typeof u[1]=="string"){u=u[1].split("&");for(var i in u){if(u[i]){var j=u[i].split("=");hash[j[0]]=j[1]}}}function reflashURL(){var hashURL="";for(var key in hash){hashURL+=key+"="+hash[key]+"&"}hashURL=hashURL.substr(0,hashURL.length-1);window.location.hash=hashURL}return{updateHash:function(hashArray){for(var key in hashArray){hash[key]=hashArray[key]}reflashURL()},deleteHash:function(hashKey){delete hash[hashKey];reflashURL()},getHash:function(key){return hash[key]},jumpUrl:function(url){window.location.href=url}}}();function Transition(dom){var callFn=new Function("");var noFn=new Function("");dom.style.transition="all .3s";dom.style["will-change"]="all";dom.style["transition-timing-function"]="";dom.style.transform="translate3d(0, 0, 0)";dom.style["backface-visibility"]="hidden";dom.style["perspective"]=1e3;dom.style.opacity=J(dom).getcss("opacity");dom.addEventListener("transitionend",function(ev){callFn.call(dom);callFn=noFn},false);function getTransform(){return dom.style.transform}return{setDuration:function(time){dom.style["transition-duration"]=time+"s";return this},setOpacity:function(num){dom.style.opacity=num;return this},set3dCoordinate:function(con){var x=con.x||0;var y=con.y||0;var z=con.z||0;dom.style.transform="translate3d("+x+","+y+","+z+")";return this},getDisplay:function(){J(dom).setcss("display","block");J(dom).getcss("display");return this},setTimefunction:function(con){if(con instanceof Object){var x1=con.x1||0;var x2=con.x2||0;var y1=con.y1||0;var y2=con.y2||0;var timeStr="cubic-bezier("+x1+", "+y1+", "+x2+", "+y2+")";dom.style["transition-timing-function"]=timeStr}else{dom.style["transition-timing-function"]=con}return this},then:function(fn){callFn=fn;return this}}}ArrayDao={indexOf:function(array,val){for(var i=0;i<array.length;i++){if(array[i]==val)return i}return-1},remove:function(array,val){var index=ArrayDao.indexOf(array,val);if(index>-1){array.splice(index,1)}}};const OP=Object.prototype;const types={obj:"[object Object]",array:"[object Array]"};const OAM=["push","pop","shift","unshift","short","reverse","splice"];class ObserveOb{constructor(obj,cb){if(OP.toString.call(obj)!==types.obj&&OP.toString.call(obj)!==types.array){return false}this._callback=cb;this.observe(obj)}observe(obj,path){if(OP.toString.call(obj)===types.array){this.overrideArrayProto(obj,path)}Object.keys(obj).forEach(key=>{let oldVal=obj[key];let pathArray=path&&path.slice();if(pathArray){pathArray.push(key)}else{pathArray=[key]}Object.defineProperty(obj,key,{get:function(){return oldVal},set:function(newVal){if(oldVal!==newVal){if(OP.toString.call(newVal)==="[object Object]"){this.observe(newVal,pathArray)}oldVal=newVal;this._callback(pathArray,newVal,oldVal)}}.bind(this)});if(OP.toString.call(obj[key])===types.obj||OP.toString.call(obj[key])===types.array){this.observe(obj[key],pathArray)}},this)}overrideArrayProto(array,path){var originalProto=Array.prototype,overrideProto=Object.create(Array.prototype),self=this,result;OAM.forEach(method=>{Object.defineProperty(overrideProto,method,{value:function(){var oldVal=this.slice();result=originalProto[method].apply(this,arguments);self.observe(this,path);self._callback(path,this,oldVal);return result}})});array.__proto__=overrideProto}}ActionSlots=function(dom,actionType,point){var domAction=[];var listener=dom;this.listener=listener;var eventType=actionType;var thisp=this;AddEvent(listener,eventType,function(ev){var target=thisp.getDomTarget(ev.target);var actionArr=thisp.getDomActionArr(target);for(var i=0;i<actionArr.length;i++){dealAction.call(target,actionArr[i],target,ev)}});function dealAction(action,target,ev){if(domAction[action]){domAction[action].call(point,target,ev)}else{return}}this.addEvent=function(action,fn){domAction[action]=fn}};ActionSlots.prototype.getDomTarget=function(dom){var target=dom;if(target.dataset.action||(target.nodeName=="CONTEXT"||target.nodeName=="BODY"||target.nodeName=="UIACTIVITY"||target==this.listener)){return target}else{return this.getDomTarget(target.parentNode)}};ActionSlots.prototype.getDomActionArr=function(target){if(target.dataset.action){return target.dataset.action.split(" ")}else{return[]}};var JTemplate=function(_OB){var target=this.loadTar=_OB.target;var method=_OB.method||[];var data=_OB.data||[];var tmpl=new Jtmpl(_OB.html);var point=document.createElement("uitemplate");target.appendChild(point);for(var k in method){this[k]=method[k]}this._setData=function(key,_data){data[key]=_data};this._start=function(){var html=tmpl.getFunction().call(this,data,method);point.innerHTML=html};this._sleep=function(){point.style.display="none"};this._activite=function(){point.style.display="block"};this._context=point};JTemplate.prototype={start:function(key,data){if(key&&data)this._setData(key,data);this._start();this._activite();return this},setData:function(key,data){if(key&&data)this._setData(key,data);this._start();return this},activite:function(){this._activite();return this},sleep:function(){this._sleep();return this},getContext:function(){return this._context},destroy:function(){this.loadTar.removeChild(this._context)}};class JView{constructor(view_id,templateFn,data){this.view_id=view_id;this.templateFn=templateFn;this.actionArr=[];this.components={};if(data){this.data=data}else{!(typeof this.__proto__.constructor.data=="function")||(this.data=this.__proto__.constructor.data())}return this}findDom(name){try{if(!this.getContext().querySelector('*[name="'+name+'"]'))throw"name:"+name+" is not find";return this.getContext().querySelector('*[name="'+name+'"]')}catch(err){console.log(err)}}findDomById(id){if(this.components[id]){return this.components[id]}try{if(!this.getContext().querySelector('*[id="'+id+'"]'))throw"id:"+id+" is not find";return this.getContext().querySelector('*[id="'+id+'"]')}catch(err){console.log(err)}}getContext(){if(!this.context){this.context=J(this.view_id).thisp}return this.context}addEvent(actionType,actionName,fn){if(this.actionArr[actionType]){this.actionArr[actionType].addEvent(actionName,fn)}else{this.actionArr[actionType]=new ActionSlots(this.getContext(),actionType,this);this.actionArr[actionType].addEvent(actionName,fn)}}set(data){this.data=data;this.getContext().innerHTML=this.templateFn.call(this,data)}initView(){return this.templateFn.call(this,this.data)}mountInit(){this.initComponents();this.onMounted()}unmount(){this.getContext().parentNode.removeChild(this.getContext())}mountAt(dom,data,props){this.props=props||{};this.data=data;this.context=document.createElement("jview");this.templateFn=templateFn(this.layout()||"");this.context.innerHTML=this.initView();dom.append(this.context);this.mountInit()}mountView(config){var onn={};var data=config.data;var el=config.tag;var id=config.id;var res=app.mountView(el,data,onn,"point");this.components[id]=onn.point;return res}onMounted(){}initComponents(){for(let id in this.components){let component=this.components[id];if(typeof component.onMounted==="function")component.mountInit()}}}class JActivity{constructor(config){this.config=config;this.data=config.data||{};this.action=config.config;this.context=null;this.actionArr=[];this.action.template=this.action.template||[];this.components={};var uiactivity=document.createElement("uiactivity");this.config.loadTarget.appendChild(uiactivity);this.config.layout.point=uiactivity;this.plugInit=new Function("");for(var k in this.action){if(isloadFn(k)){this[k]=this.action[k]}}function isloadFn(action){var checkFnArr=["init","activite","sleep","destroy","name","type"];for(var k in checkFnArr){if(action==checkFnArr[k])return false}return true}this._init=function(){this._templateFn=templateFn(this.config.layout.data||this.action.layout.text||this.action.layout);this.config.layout.point.innerHTML=this._templateFn.call(this,this.data);this.context=this.getContext();if(this._preInit){this._preInit()}if(this.action.init){this.action.init.apply(this,arguments)}this.plugInit()};this._activite=function(){this.config.layout.point.style.display="block";if(this.action.activite){this.action.activite.apply(this,arguments)}};this._sleep=function(){if(this.action.sleep){this.action.sleep.apply(this,arguments)}this.config.layout.point.style.display="none"};this._destroy=function(){if(this.action.destroy){this.action.destroy.apply(this,arguments)}APP.deleteJActivity(this.action.name)};this._updateState=function(newState){this.config.state=newState};this.getState=function(){return this.config.state}}init(){var state="paused";this._updateState(state);this._init.apply(this,arguments);this.initComponents();return this}activite(){var state="active";this._updateState(state);this._activite.apply(this,arguments);return this}sleep(){var state="paused";this._updateState(state);this._sleep.apply(this,arguments)}destroy(){this._destroy.apply(this,arguments)}loadTemplate(name,target){var _ob=APP.clone(this.action.template[name]);_ob.target=target;try{if(!this.config.layout.point.querySelector('script[data-name="'+name+'"]'))throw"act-name:"+name+" is not find";_ob.html=this.config.layout.point.querySelector('script[data-name="'+name+'"]').innerHTML}catch(err){console.error(err)}return new JTemplate(_ob)}render(str,target){var _ob=APP.clone(this.action.template[name]);_ob.target=target;try{_ob.html=str}catch(err){console.log(err)}return new JTemplate(_ob)}findDom(name){try{if(!this.context.querySelector('*[name="'+name+'"]'))throw"name:"+name+" is not find";return this.context.querySelector('*[name="'+name+'"]')}catch(err){console.log(err)}}findDomById(id){if(this.components[id]){return this.components[id]}try{if(!this.context.querySelector('*[id="'+id+'"]'))throw"id:"+id+" is not find";return this.context.querySelector('*[id="'+id+'"]')}catch(err){console.log(err)}}getContext(){var dom=this.config.layout.point;for(var i=0;i<dom.childNodes.length;i++){if(dom.childNodes[i].nodeName=="CONTEXT")return dom.childNodes[i]}return this.config.layout.point}getTemplate(){var dom=this.config.layout.point;var templateArr=[];for(var i=0;i<dom.childNodes.length;i++){if(dom.childNodes[i].nodeName=="SCRIPT"){templateArr.push(dom.childNodes[i]);if(dom.childNodes[i].dataset.name){templateArr[dom.childNodes[i].dataset.name]=dom.childNodes[i]}}}return templateArr}loadActivity(modname,runname,targetLoadDom,type){return APP.loadJActivity(this,modname,runname,targetLoadDom,type)}addEvent(actionType,actionName,fn){if(this.actionArr[actionType]){this.actionArr[actionType].addEvent(actionName,fn)}else{this.actionArr[actionType]=new ActionSlots(this.config.layout.point,actionType,this);this.actionArr[actionType].addEvent(actionName,fn)}}reflash(data){this.config.layout.point.innerHTML=this._templateFn(data)}mountView(config){var onn={};var data=config.data;var el=config.tag;var id=config.id;var res=app.mountView(el,data,onn,"point");this.components[id]=onn.point;return res}initComponents(){for(let id in this.components){let component=this.components[id];if(typeof component.onMounted==="function")component.mountInit()}}}var head=document.getElementsByTagName("head")[0];function templateFn(html){var dealHtml=html.replace(/{{=([\s\S]*?)}}/g,"');p.push($1);p.push('");dealHtml=dealHtml.replace(/{{/g,"');");dealHtml=dealHtml.replace(/}}/g,"p.push('");dealHtml=" try { var p=[];p.push('"+dealHtml+"'); } catch (e) { console.error(e); }return p.join(''); ";dealHtml=dealHtml.replace(/[\r\t\n]/g,"");try{var fn=new Function("data",dealHtml)}catch(e){console.log(e)}return fn}class ResMgr{constructor(){this.nodeArr=["layout","style","script"];ResMgr.res={}}getNodeContext(nodeName,text){var r=new RegExp("<("+nodeName+"+)(.*)?>([\\s\\S]*?)<\\/\\1>","gm");var result;var resArr=[];while((result=r.exec(text))!=null){var attributestr=(result[2]||"").replace(/"/g,"").replace(/'/g,"");var resObj={nodeName:result[1],text:result[3],attributes:{}};var attributeArr=attributestr.split(" ");for(var i=0;i<attributeArr.length;i++){var one=attributeArr[i];if(one){var arr=one.split("=");resObj.attributes[arr[0]]=arr[1]}}resObj.id=resObj.attributes.id||null;resArr.push(resObj)}return resArr}loadResForText(text){var resArr=this.getNodeContext(this.nodeArr.join("|"),text);return resArr}dealResArrForNodename(resArr){var key=parseInt(Math.random()*1e8);app.temp[key]=resArr;var pArr=[];for(var i=0;i<resArr.length;i++){var res=resArr[i];var text=res.text;if(res.id){ResMgr.res[res.id]=res}if(res.attributes["data-id"]){resArr[res.attributes["data-id"]]=res}switch(res.nodeName){case"style":var style=document.createElement("style");style.innerHTML=text;head.appendChild(style);break;case"script":text=`\n                (function(resMap){\n                    ${text}\n                }(app.temp[${key}]));`;pArr.push(loadJsCode(text));break;default:break}}return Promise.all(pArr)}}class templateDom{constructor(dom,template_html,point){this.dom=dom;this.point=point||this;this.templateFn=templateFn(template_html||dom.innerHTML)}set(data){this.dom.innerHTML=this.templateFn.call(this.point,data)}}function loadText(url){return new Promise(function(resolve,reject){Jajax({url:url,type:"get",complete:function(data){resolve(data)},error:function(){console.error(url+" is not exist");reject(url+" is not exist")}})})}function loadXml(text){return(new DOMParser).parseFromString(text,"text/xml")}function loadLayout(url){if(/\.js$/.test(url)){return loadScript(url)}return loadText(url).then(function(data){return app.res(data)})}function dealLayoutType(text,type){if(!type)return;switch(type){case"text/css":var style=document.createElement("style");style.innerHTML=text;head.appendChild(style);break;case"text/javascript":text=text.replace(/&lt;/g,"<");text=text.replace(/&gt;/g,">");var blob=new Blob([text],{type:type});var blobUrl=window.URL.createObjectURL(blob);loadScript(blobUrl);break;default:break}}function getXmlDomType(dom){try{return dom.attributes.type.value}catch(error){return null}}function loadScript(url,attributes){return new Promise(function(resolve,reject){var script=document.createElement("script");script.src=url;if(attributes){for(var key in attributes){script[key]=attributes[key]}}script.onload=function(){resolve()};head.appendChild(script)})}function loadJsCode(text){return new Promise(function(resolve,reject){var script=document.createElement("script");script.type="text/javascript";script.text=text;script.onload=function(){};document.body.appendChild(script);resolve()})}function loadScriptArr(urlArr){if(urlArr){var length=urlArr.length;return new Promise(function(resolve,reject){_loadScript(0);function _loadScript(num){if(num<length){var url=urlArr[num]+"?v="+app.version;loadScript(url).then(function(){num++;_loadScript(num)})}else{resolve()}}})}else{return Promise.resolve()}}function loadCSS(url){return new Promise(function(resolve,reject){var linkTag=document.createElement("link");linkTag.href=url;linkTag.setAttribute("rel","stylesheet");linkTag.setAttribute("type","text/css");head.appendChild(linkTag);linkTag.onload=function(){resolve()}})}function loadCSSArr(urlArr){if(urlArr){var pArr=[];for(var i=0;i<urlArr.length;i++){pArr.push(loadCSS(urlArr[i]+"?v="+app.version))}return Promise.all(pArr)}else{return Promise.resolve()}}function loadActivity(name){var activityInf=APP.getActivityInf(name);var promiseArr=[];if(activityInf.layout.url){var promiseText=loadText(activityInf.layout.url);promiseText.then(function(data){activityInf.layout.data=data});promiseArr.push(promiseText)}if(activityInf.script){var promiseScript=loadScript(activityInf.script);promiseScript.then(function(){});promiseArr.push(promiseScript)}if(activityInf.css){var promiseCSS=loadCSS(activityInf.css);promiseCSS.then(function(){});promiseArr.push(promiseScript)}return Promise.all(promiseArr)}function preImgCache(url){return new Promise(function(resolve,reject){var img=new Image;img.src=url;img.onload=function(){resolve()}})}function preImgCacheArr(urlArr){if(urlArr){var pArr=[];for(var i=1;i<urlArr.length;i++){pArr.push(preImgCache(urlArr[i]))}return Promise.all(pArr)}else{return Promise.resolve()}}var objectManager=APP=app=function(){appInf=[];appRunStack={};appInf["activity"]=[];appInf["layout"]=[];appInf["view_config"]=[];appInf["res"]=[];appInf["dynamicLoadActivityMap"]={};return{resMgr:new ResMgr,temp:{},create:function(_class){var _object={};_object.__proto__=_class.prototype;_object.__proto__.constructor=_class;var args=Array.prototype.slice.call(arguments);args=args.slice(1,args.length);_class.apply(_object,args);return _object},clone:function(object){function F(){}F.prototype=object;return new F},storeActivtyConfig:function(config){try{if(!appInf["activity"][config.name])throw config.name+" is not find";appInf["activity"][config.name].config=config}catch(err){appInf["activity"][config.name]={};appInf["activity"][config.name].config=config}},getActivityInf:function(name){return appInf.activity[name]},getRunActivityInf:function(name){return appRunStack[name]},loadActivityArray:function(loadName){var loadName=loadName;var pArr=[];for(var k in appInf[loadName]){pArr.push(loadActivity(k))}return Promise.all(pArr)},getActivity:function(name){try{if(!appRunStack[name])throw new Error("The Activity named "+name+" is not runstack");return appRunStack[name].point}catch(e){console.log(e);return false}},loadJActivity:function(transferActivity,modname,runname,targetLoadDom,type){var targetLoadDom=targetLoadDom||document.querySelector("viewport");if(J(targetLoadDom).getcss("position")=="static"){J(targetLoadDom).setcss("position","relative")}if(!appInf.activity[modname]){console.error(modname+" is not exist");return}var Jtype=appInf.activity[modname].config.type||"JActivity";var activity={};appRunStack[runname]=activity;activity.name=runname;activity.transfer=transferActivity||"root";activity.layout=this.clone(appInf.activity[modname].layout);Jtype=eval(Jtype);activity.Jtype=Jtype;activity.config=this.clone(appInf.activity[modname].config);activity.config.name=runname;activity.loadTarget=targetLoadDom;activity.point=new Jtype(activity);activity.state="unload";activity.point.transfer=activity.transfer;return activity.point},loadGlobalJActivity:function(modname,runname,type){if(arguments.length==1){var key=parseInt(Math.random()*1e8);return this.loadJActivity(null,modname,modname+key,null,null)}return this.loadJActivity(null,modname,runname,null,type)},deleteJActivity:function(name){var activity=appRunStack[name];activity.loadTarget.removeChild(activity.layout.point);delete appRunStack[name]},define:function(config){if(config.name){if(!window[config.type])window[config.type]=null;this.storeActivtyConfig(config);app.resMgr.curLoadActivity=config.name}},initLoad:function(name,url,fn){},loadManifest:function(name,url){function loadManifest(data){if(data.name)document.getElementsByTagName("title")[0].innerHTML=data.name||"未命名";if(data.icon){var iconlink=document.createElement("link");iconlink.href=data.icon.url;iconlink.type="image/x-icon";iconlink.rel="icon";head.appendChild(iconlink)}var activityArray=data["activity"];var cssArr=data["CSS"]||data["css"];var scriptArr=data["script"];var layout=data["layout"]||data["res"];if(data.version)app.version=data.version;appInf[loadName]=[];for(var k in activityArray){var layout_url=activityArray[k].layout;var temp=activityArray[k];temp.layout=[];temp.layout.url=layout_url;appInf.activity[activityArray[k].name]=temp;appInf[loadName][activityArray[k].name]=temp}if(scriptArr){return loadScriptArr(scriptArr).then(function(){pArr.push(APP.loadLayoutArr(layout));pArr.push(preImgCacheArr(data.preImage));pArr.push(APP.loadActivityArray(loadName));!cssArr||pArr.push(loadCSSArr(cssArr));pArr.push(loadAsyncArr(data.asyncTask));return Promise.all(pArr)})}else{pArr.push(APP.loadLayoutArr(layout));pArr.push(preImgCacheArr(data.preImage));pArr.push(APP.loadActivityArray(loadName));!cssArr||pArr.push(loadCSSArr(cssArr));pArr.push(loadAsyncArr(data.asyncTask));return Promise.all(pArr)}function loadAsyncArr(asyncTask){if(!asyncTask||asyncTask.length<1)return Promise.resolve();var arr=[];asyncTask.forEach(function(one){arr.push(loadAsync(one))});return Promise.all(arr)}function loadAsync(url){return loadScript(url).then(function(){return app.async()})}}var loadName=name||(new Date).getTime();var pArr=[];if(typeof name==="object"&&name!==null){loadName=Math.random()*1e16;return loadManifest(name)}return loadText(url+"?v="+(new Date).getTime()).then(function(json){var data=eval("("+json+")");return loadManifest(data)})},preCache:function(url){var pArr=[];return loadText(url).then(function(json){var data=eval("("+json+")");var imgArr=data.img;pArr.push(APP.preImgCacheArr(imgArr));return Promise.all(pArr)})},loadLayoutArr:function(urlArr){if(!urlArr||urlArr.length<1){return Promise.resolve()}var pArr=[];for(var i=0;i<urlArr.length;i++){pArr.push(loadLayout(urlArr[i]))}return Promise.all(pArr)},getAppLayout:function(){return appInf.layout},res:function(text){var arr=app.resMgr.loadResForText(text);return app.resMgr.dealResArrForNodename(arr)},getRes:function(res){if(ResMgr.res[res]){return ResMgr.res[res]}var pathArr=res.split("/");try{var point=appInf.Res;while(path=pathArr.shift()){point=point[path]}if(!point)throw new error;return point}catch(error){console.log(res+" 资源不存在");return false}},css:function(text){var style=document.createElement("style");style.innerHTML=text;head.appendChild(style)},view:function(ob){ob.templateFn=templateFn(ob.layout);if(ob.el){appInf["view_config"][ob.el]=ob}if(ob.name){app[ob.name]=ob}try{if(typeof ob.init==="function"){ob.init()}}catch(e){}},mountView:function(el,data,_this,key){if(Object.getPrototypeOf(el)===JView){var template=templateFn(el.layout());var ViewClass=el}else{var template=getViewModel(el).templateFn;var ViewClass=JView}var viewid=parseInt(Math.random()*1e8)+""+(new Date).getTime();var a;if(arguments.length==4){_this[key]=new ViewClass(viewid,template,data);a=_this[key].initView()}else{a=template(data)}var str=`<jview id="${viewid}">${a}</jview>`;return str;function getViewModel(el){if(!appInf["view_config"][el]){var ob={el:el,layout:app.getRes(el).text};ob.templateFn=templateFn(ob.layout);appInf["view_config"][ob.el]=ob}return appInf["view_config"][el]}},getSvg:function(path){var svgRes=app.getRes(path);if(svgRes){var blob=new Blob([svgRes.text],{type:"image/svg+xml"});var blobUrl=window.URL.createObjectURL(blob);return blobUrl}},loadcss:function(path){var cssRes=app.getRes(path);if(cssRes){var text=templateFn(cssRes.text)();var style=document.createElement("style");style.innerHTML=text;head.appendChild(style)}},model:function(ob){app[ob.name]=ob;try{if(typeof ob.init==="function"){ob.init()}}catch(e){}},dynamicLoadActivity:function(url){if(appInf.dynamicLoadActivityMap[url]){return Promise.resolve(appInf.dynamicLoadActivityMap[url])}return loadLayout(url).then(function(){appInf.dynamicLoadActivityMap[url]=app.resMgr.curLoadActivity;return Promise.resolve(app.resMgr.curLoadActivity)})}}}();